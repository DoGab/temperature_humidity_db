<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>

function getTempData(data) {
  var dataArray = [];
  for(var i = 0; i < data.length; i++) {
    var time = new Date(data[i].timestamp);
    dataArray.push({
		  x: time,
		  y: data[i].temperature
	  });
    //alert(time);
  }
  return dataArray;
}

function getHumData(data) {
  var dataArray = [];
  for(var i = 0; i < data.length; i++) {
    var time = new Date(data[i].timestamp);
    dataArray.push({
		  x: time,
		  y: data[i].humidity
	  });
    //alert(time);
  }
  return dataArray;
}

function refresh() {
  getChart();
}

function getHours() {
  hours = document.getElementById("hours").value;
  if (hours == null || hours == 0) {
    hours = 10;
  }
  hours = {'hours': hours};
  return hours;
}


function getChart() {

  event.preventDefault();

  var post_hours = getHours();
  //console.log(post_hours);

  var request;
  request = $.ajax({
    type: "POST",
    url: "/sqlite_query.php",
    data: post_hours,
    dataType: 'json',
  });

  request.fail(function() {
    console.log("error while ajax call");
  });


  request.done(function(msg) {
    //console.log(msg);

    var dataPoints1 = getTempData(msg);
    //console.log(JSON.stringify(dataPoints1));
    var dataPoints2 = getHumData(msg);
    //console.log(dataPoints2);

    var chart = new CanvasJS.Chart("chartContainer", {
	animationEnabled: true,
	title:{
		text: "Graph"
	},
	toolTip: {
		shared: true
	},
	axisX: {
		title: "Time",
	},
	axisY: {
		title: "Temperature",
		titleFontColor: "#4F81BC",
		suffix : "°C",
		minimum : 10,
		maximum : 40,
		lineColor: "#4F81BC",
		tickColor: "#4F81BC"
	},
	axisY2: {
		title: "Humidity",
		titleFontColor: "#C0504E",
		suffix : "%",
		minimum : 0,
		maximum : 60,
		lineColor: "#C0504E",
		tickColor: "#C0504E"
	},
	data: [{
		type: "spline",  
		axisYType: "secondary",
		name: "humidity",
    xValueType: "dateTime",
    xValueFormatString: "DD-MM-YYYY HH:mm",
		yValueFormatString: "#,#0.# %",
		dataPoints: dataPoints2
	},
    {
		type: "spline",
		name: "temperature",
    xValueType: "dateTime",
		yValueFormatString: "#,##0.00°",
		dataPoints: dataPoints1
	}]
    });

    chart.render();

    return chart;
  });
}

window.onload = function () {

  getChart();

}
</script>
</head>
  <body>
    <div id="main" class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-lg-12">
          <h1>Temperature and Humidity Visualizer</h1>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-lg-12">
	  <div id="chartContainer" style="height: 370px; width: 100%;"></div>
	  <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
	  <form class="form-inline">
	    <div class="form-group">
	      <label for="usr">Last hours:</label>
	      <input type="number" name="enter" class="form-control" value="10" id="hours"/>
	      <button type="button" class="btn btn-primary" onclick="refresh()">Refresh</button>
	    </div>
	  </form>
        </div>
      </div>
    </div>
  </body>
</html>
